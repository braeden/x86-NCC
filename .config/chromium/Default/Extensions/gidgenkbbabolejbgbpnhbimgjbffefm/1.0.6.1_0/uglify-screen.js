function nextTick(cb){setTimeout(cb,0)}function make4Len16(len){var len16=len.toString(16);while(len16.length<4){len16="0"+len16}return len16}var pendingFuncs;window.addEventListener("message",function(){if(pendingFuncs){$.each(pendingFuncs,function(i,func){func()});pendingFuncs=null}},false);function unsafeCallback(cb){return cb}function ab2str(buf){if(buf.constructor.name=="ArrayBuffer"){buf=new Uint8Array(buf)}return String.fromCharCode.apply(null,buf)}function str2ab(str,buf,terminate){var len=str.length;if(terminate)len++;if(!buf){buf=new ArrayBuffer(len)}var bufView=new Uint8Array(buf);if(terminate)bufView[str.length]=0;for(var i=0,strLen=str.length;i<strLen;i++){bufView[i]=str.charCodeAt(i)}return buf}var slashN="\n".charCodeAt(0);function writeLine(socket,str,cb){socket.write(str2ab(str+"\n"),cb)}function readLine(socket,cb){var pending=[];function readMore(){socket.read(function(buffer){for(var i=0;i<buffer.byteLength;i++){if(buffer[i]==slashN){var keep=buffer.subarray(0,i);pending.push(keep);var data="";for(var b in pending){b=pending[b];data+=ab2str(b)}var remaining=buffer.subarray(i+1);socket.unshift(remaining);cb(data);return}}pending.push(buffer);readMore()})}readMore()}function readString(socket,cb){var str="";socket.onClose=function(){cb(str)};function reader(data){str+=ab2str(data);socket.read(reader)}socket.read(reader)}function appendBuffer(buffer1,buffer2){var tmp=new Uint8Array(buffer1.byteLength+buffer2.byteLength);tmp.set(buffer1,0);tmp.set(buffer2,buffer1.byteLength);return tmp}var timeThing=(new Date).getTime();function timeTrace(stamp){var now=(new Date).getTime();console.log(stamp+": "+(now-timeThing));timeThing=now}function bufferToHex(buffer){var view=new Uint8Array(buffer);var ret="";for(var b in view){b=view[b];if(b<16)ret+="0"+b.toString(16);else ret+=b.toString(16)}return ret}function hexToBuffer(str){var buf=new ArrayBuffer(str.length/2);var view=new Uint8Array(buf);for(var i=0;i<str.length/2;i++){var c=str.substr(i*2,2);view[i]=parseInt(c,16)}return buf}function base64ToArrayBuffer(base64){var binary_string=window.atob(base64);var len=binary_string.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){var ascii=binary_string.charCodeAt(i);bytes[i]=ascii}return bytes.buffer}function arrayBufferToBase64(buffer){var binary="";var bytes=new Uint8Array(buffer);var len=bytes.byteLength;for(var i=0;i<len;i++){binary+=String.fromCharCode(bytes[i])}return window.btoa(binary)}var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64pad="=";function hex2b64(h){var i;var c;var ret="";for(i=0;i+3<=h.length;i+=3){c=parseInt(h.substring(i,i+3),16);ret+=b64map.charAt(c>>6)+b64map.charAt(c&63)}if(i+1==h.length){c=parseInt(h.substring(i,i+1),16);ret+=b64map.charAt(c<<2)}else if(i+2==h.length){c=parseInt(h.substring(i,i+2),16);ret+=b64map.charAt(c>>2)+b64map.charAt((c&3)<<4)}while((ret.length&3)>0){ret+=b64pad}return ret}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,"startsWith",{enumerable:false,configurable:false,writable:false,value:function(searchString,position){position=position||0;return this.lastIndexOf(searchString,position)===position}})}function getQueryVariable(variable){var query=window.location.search.substring(1);var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");if(decodeURIComponent(pair[0])==variable){return decodeURIComponent(pair[1])}}console.log("Query variable %s not found",variable)}Object.fromArray=function(arr){var ret={};for(var i in arr){var val=arr[i];ret[val]=val}return ret};$.ajaxTransport("+binary",function(options,originalOptions,jqXHR){if(window.FormData&&(options.dataType&&options.dataType=="binary"||options.data&&(window.ArrayBuffer&&options.data instanceof ArrayBuffer||window.Blob&&options.data instanceof Blob))){return{send:function(headers,callback){var xhr=new XMLHttpRequest,url=options.url,type=options.type,async=options.async||true,dataType=options.responseType||"blob",data=options.data||null,username=options.username||null,password=options.password||null;xhr.addEventListener("load",function(){var data={};data[options.dataType]=xhr.response;callback(xhr.status,xhr.statusText,data,xhr.getAllResponseHeaders())});xhr.open(type,url,async,username,password);for(var i in headers){xhr.setRequestHeader(i,headers[i])}xhr.responseType=dataType;xhr.send(data)},abort:function(){jqXHR.abort()}}}});function throttleTimeout(token,item,throttle,cb){if(token){clearTimeout(token.timeout)}else{token={items:[]}}token.timeout=setTimeout(function(){cb(token.items);token.items=[]},throttle);token.items.push(item);return token}function copyTextToClipboard(text){var textArea=document.createElement("textarea");textArea.style.position="fixed";textArea.style.top=0;textArea.style.left=0;textArea.style.width="2em";textArea.style.height="2em";textArea.style.padding=0;textArea.style.border="none";textArea.style.outline="none";textArea.style.boxShadow="none";textArea.style.background="transparent";textArea.value=text;document.body.appendChild(textArea);textArea.select();try{var successful=document.execCommand("copy")}catch(err){console.log("Oops, unable to copy")}document.body.removeChild(textArea)}function showNotification(text){console.log("notification:",text);var appName=chrome.runtime.getManifest().name;chrome.notifications.create({type:"basic",iconUrl:"/icon.png",title:appName,message:text})}var readers={};chrome.sockets.tcp.onReceive.addListener(function(resultData){var socket=readers[resultData.socketId];if(socket==null)return;socket.dataReceived(new Uint8Array(resultData.data))});chrome.sockets.tcp.onReceiveError.addListener(function(resultData){var socket=readers[resultData.socketId];if(socket==null)return;socket.destroy();socket.dataReceived(null)});function Socket(options,cb){if(options.socketId){this.socketId=options.socketId;readers[this.socketId]=this}else{chrome.sockets.tcp.create(function(createInfo){this.socketId=createInfo.socketId;chrome.sockets.tcp.connect(this.socketId,options.host,options.port,function(result){chrome.runtime.lastError;if(!result){readers[createInfo.socketId]=this;cb(this)}else{this.destroy();cb(null)}}.bind(this))}.bind(this))}}Socket.connect=function(options,cb){return new Socket(options,cb)};Socket.pump=function(s1,s2,cb){var writeDone=function(){s1.read(reader)}.bind(s1);var reader=function(data){var buffer=data.buffer;if(data.byteOffset||data.length!=buffer.byteLength){buffer=buffer.slice(data.byteOffset,data.byteOffset+data.length)}s2.write(buffer,writeDone)}.bind(s2);s1.read(reader);s1.onClose=cb};Socket.stream=function(s1,s2,cb){Socket.pump(s1,s2,function(){s2.destroy();if(cb){var tmp=cb;cb=null;tmp()}});Socket.pump(s2,s1,function(){s1.destroy();if(cb){var tmp=cb;cb=null;tmp()}})};Socket.eat=function(s){function reader(){s.read(reader)}reader()};Socket.prototype.init=function(){chrome.sockets.tcp.onReceive.addListener(function(receiveInfo){if(acceptInfo.socketId!=createInfo.socketId){return}})};Socket.prototype.read=function(){if(this.pendingCallback){throw new Error("double callback")}if(this.closed&&!this.pending){var cb=this.onClose;if(cb){delete this.onClose;cb()}return}var argc=0;if(arguments[argc].constructor.name=="Number"){this.pendingLength=arguments[argc++]}else{this.pendingLength=0}var cb=arguments[argc];if(!this.pending||this.paused){this.pendingCallback=cb;return}if(!this.pendingLength){this.pendingLength=this.buffered()}else if(this.pendingLength>this.buffered()){this.pendingCallback=cb;return}var data;var totalRead=0;while(totalRead<this.pendingLength){var buf=this.pending.shift();if(!this.pending.length)delete this.pending;var add=buf;var need=Math.min(add.byteLength,this.pendingLength-totalRead);if(need!=add.byteLength){var part=add.subarray(0,need);var leftover=add.subarray(need);this.unshift(leftover);add=part}if(!data&&add.byteLength!=this.pendingLength)data=new Uint8Array(this.pendingLength);if(data){data.set(add,totalRead)}else{data=add}totalRead+=add.byteLength}cb(data)};Socket.prototype.write=function(data,cb){chrome.sockets.tcp.send(this.socketId,data,function(writeInfo){chrome.runtime.lastError;if(!writeInfo||writeInfo.resultCode){return}if(writeInfo.bytesSent<data.byteLength){this.write(data.slice(writeInfo.bytesSent),cb)}else{cb()}}.bind(this))};Socket.prototype.destroy=function(data,cb){chrome.sockets.tcp.close(this.socketId,function(){chrome.runtime.lastError})};Socket.prototype.unshift=function(buffer){if(buffer.byteLength==0)return;if(!this.pending)this.pending=[buffer];else this.pending.unshift(buffer)};Socket.prototype.dataReceived=function(payload){if(payload&&payload.length){var arr=new Uint8Array(payload);if(!this.pending)this.pending=[arr];else this.pending.push(arr)}if(payload==null)this.closed=true;if(this.paused||!this.pending||!this.pending.length){var cb=this.onClose;if(this.closed&&cb){delete this.onClose;cb()}return}var pl=this.pendingLength;var cb=this.pendingCallback;if(cb){delete this.pendingCallback;this.read(pl,cb)}};Socket.prototype.buffered=function(){var ret=0;if(this.pending){for(var buf in this.pending){buf=this.pending[buf];ret+=buf.byteLength}}return ret};Socket.prototype.pause=function(){if(this.paused){return}this.paused=true;this.onPause()};Socket.prototype.resume=function(){if(!this.paused){return}this.paused=false;this.onResume()};Socket.prototype.onResume=function(){chrome.sockets.tcp.setPaused(this.socketId,false,function(){})};Socket.prototype.onPause=function(){chrome.sockets.tcp.setPaused(this.socketId,true,function(){})};function Server(){}Server.prototype.__proto__=Socket.prototype;Server.prototype.destroy=function(){chrome.sockets.tcpServer.close(this.socketId)};var listeners={};chrome.sockets.tcpServer.onAccept.addListener(function(acceptInfo){chrome.sockets.tcp.setPaused(acceptInfo.clientSocketId,false);var listener=listeners[acceptInfo.socketId];if(listener==null)return;listener(new Socket({socketId:acceptInfo.clientSocketId}))});Server.prototype.listen=function(args,cb,listening){var port;var address;if(args.constructor.name=="Number"){port=args;address="0.0.0.0"}else{address=args.address;port=args.port}chrome.sockets.tcpServer.create(function(createInfo){this.socketId=createInfo.socketId;listeners[this.socketId]=cb;chrome.sockets.tcpServer.listen(createInfo.socketId,address,port,function(result){chrome.runtime.lastError;if(result){this.destroy();if(listening){listening(result)}return}chrome.sockets.tcpServer.getInfo(this.socketId,function(info){this.localAddress=info.localAddress;this.localPort=info.localPort;if(listening){listening(result)}}.bind(this))}.bind(this))}.bind(this))};function FetchSocket(url,cb){this.promise=fetch(url).then(function(response){this.connected=true;this.response=response;this.reader=this.response.body.getReader();this.reader.closed.then(function(){if(this.onClose)this.dataReceived(null)}.bind(this));this.onResume();cb(this)}.bind(this),function(error){cb(null,error)})}FetchSocket.connect=function(url,cb){new FetchSocket(url,cb)};FetchSocket.prototype.write=function(data,cb){throw new Error("write not supported on fetch socket")};FetchSocket.prototype.destroy=function(){if(this.promise&&this.promise.cancel)this.promise.cancel()};FetchSocket.prototype.unshift=Socket.prototype.unshift;FetchSocket.prototype.dataReceived=Socket.prototype.dataReceived;FetchSocket.prototype.read=Socket.prototype.read;FetchSocket.prototype.pause=Socket.prototype.pause;FetchSocket.prototype.resume=Socket.prototype.resume;FetchSocket.prototype.buffered=Socket.prototype.buffered;FetchSocket.prototype.onPause=function(){};FetchSocket.prototype.onResume=function(){this.reader.read().then(function(chunk){if(!chunk.value)return;this.dataReceived(chunk.value);if(this.paused){return}this.onResume()}.bind(this))};var headFader;var screenWidth;var screenHeight;var inputWebSocket;var h264Socket;var rectLeft;var rectTop;var rectWidth;var rectHeight;var titleBarHeight=24;var bottomBarHeight=48;function sendEvent(e){if(!inputWebSocket)return;if(e.clientX){e.clientX=e.clientX/window.innerWidth*screenWidth}if(e.clientY){var bottomBarStart=window.innerHeight-bottomBarHeight;if(e.clientY>=bottomBarStart)return;var touchableHeight=window.innerHeight-bottomBarHeight;e.clientY=e.clientY/touchableHeight*screenHeight}inputWebSocket.send(JSON.stringify(e))}function delayFadeHead(){$(".head").fadeTo(0,.8);clearTimeout(headFader);headFader=setTimeout(function(){$(".head").fadeOut()},2e3)}$(window).focus(function(){delayFadeHead();sendEvent({type:"wakeup"})});$(window).bind("paste",function(e){var pastedData=e.originalEvent.clipboardData.getData("text");if(pastedData&&pastedData.length){sendEvent({type:"keychar",keychar:pastedData})}});window.addEventListener("mousewheel",function(e){sendEvent({type:"scroll",clientX:e.clientX,clientY:e.clientY,deltaX:e.wheelDeltaX/100,deltaY:e.wheelDeltaY/100})},false);$(window).keypress(function(e){var s=String.fromCharCode(e.keyCode);if(!s.length)return;sendEvent({type:"keychar",keychar:s})});$(window).keydown(function(e){if(e.keyCode==36){sendEvent({type:"home"});return}else if(e.keyCode==27){sendEvent({type:"back"});return}else if(e.keyCode==112){sendEvent({type:"menu"});return}else if(e.keyCode==113){delayFadeHead();return}else if(e.keyCode==8){sendEvent({type:"backspace"});return}else if(e.keyCode==38){sendEvent({type:"up"});return}else if(e.keyCode==40){sendEvent({type:"down"});return}else if(e.keyCode==37){sendEvent({type:"left"});return}else if(e.keyCode==39){sendEvent({type:"right"});return}else{}});$(window).mouseup(function(e){if(e.button!=0)return;sendEvent({type:e.type,clientX:e.clientX,clientY:e.clientY})});$(window).mousedown(function(e){if(e.button==1){sendEvent({type:"home"});return}if(e.button==2){sendEvent({type:"back"});return}if(e.button!=0)return;sendEvent({type:e.type,clientX:e.clientX,clientY:e.clientY})});$(window).mousemove(function(e){if((e.buttons&1)==0)return;sendEvent({type:e.type,clientX:e.clientX,clientY:e.clientY})});var resizeTimeout;$(window).resize(function(e){if(!screenHeight||!screenWidth)return;clearTimeout(resizeTimeout);resizeTimeout=setTimeout(function(){var newScreenHeight=chrome.app.window.current().innerBounds.width*(screenHeight/screenWidth);rectWidth=chrome.app.window.current().innerBounds.width;rectHeight=Math.round(newScreenHeight);resizeWindow()},500)});function enforceAspectRatio(ow,oh){if(oh==screenWidth&&ow==screenHeight){var tmp=rectWidth;rectWidth=rectHeight;rectHeight=tmp}else{var newScreenHeight=chrome.app.window.current().innerBounds.width*(screenHeight/screenWidth);rectWidth=chrome.app.window.current().innerBounds.width;rectHeight=Math.round(newScreenHeight)}resizeWindow()}function resizeWindow(){if(rectWidth>screen.availWidth){rectWidth=screen.availWidth;rectHeight=Math.round(screenHeight/screenWidth*rectWidth)}var windowDecorHeight=outerHeight-innerHeight;if(rectHeight+bottomBarHeight+windowDecorHeight>screen.availHeight){rectHeight=screen.availHeight-bottomBarHeight-windowDecorHeight;rectWidth=Math.round(screenWidth/screenHeight*rectHeight)}var c=$("#mirror");var canvasElement=c[0];chrome.app.window.current().innerBounds.width=rectWidth;chrome.app.window.current().innerBounds.height=rectHeight+bottomBarHeight;canvasElement.width=rectWidth;canvasElement.height=rectHeight;c.css("left",0);c.css("top",0);$("#dead").width(rectWidth);$("#dead").height(rectHeight+bottomBarHeight)}window.docready=function(){$("#loading").fadeIn();$("#dead").fadeOut();delayFadeHead();if(!window.port)return;$("#serialno").text(serialno);console.log("init");function withSocket(socket){console.log("received socket",socket);if(h264Socket){h264Socket.destroy()}h264Socket=socket;$(".overlay").fadeOut();if(!socket){$("#dead").fadeIn();return}socket.onClose=function(){$("#dead").fadeIn();inputWebSocket=null};var defaultConfig={filter:"original",filterHorLuma:"optimized",filterVerLumaEdge:"optimized",getBoundaryStrengthsA:"optimized"};var canvas;var asmInstance;var avc=new Avc;avc.configure(defaultConfig,function(){console.log("callback for avc")});avc.onPictureDecoded=function(buffer,width,height){if(!buffer){console.log("no buffer?");return}if(!canvas){console.log("first frame decoded");tracker.sendEvent("view-device");var c=$("#mirror");var canvasElement=c[0];canvas=new WebGLCanvas(canvasElement,undefined,{});if(!canvas.contextGL){var appName=chrome.runtime.getManifest().name;chrome.notifications.create("enableWebGL",{type:"basic",iconUrl:"/icon.png",title:appName,message:"WebGL is disabled in Chrome. Enable it for Vysor to work properly.",isClickable:true,buttons:[{title:"Enable WebGL"}]})}}if(!rectWidth||!rectHeight)return;canvas.drawNextOutputPicture(width,height,{left:0,top:0,width:rectWidth,height:rectHeight},buffer)};var isSps=true;var payloadReader=function(data){var video=data.subarray(8);if(isSps){isSps=false;if(video[5]!=66&&video.byteLength>=6)showNotification("Your Android needs to send H264 Baseline by default. You may get this error and see a black screen if running a custom ROM.")}avc.decode(video);socket.read(4,headerReader)};var headerReader=function(data){if(data.byteLength!=4){throw new Error("WTF")}var lenBuf=new DataView(data.buffer,data.byteOffset,4);var len=lenBuf.getInt32(0,true);socket.read(len,payloadReader)};var firstRead=setTimeout(function(){showNotification("Your Android screen is unavailable right now. This can sometimes be resolved by rebooting your Android.")},5e3);socket.read(4,function(data){clearTimeout(firstRead);headerReader(data)})}function connect264(){if(vysorVirtualDevices[serialno]){console.log("vysor socket fast path");var vd=vysorVirtualDevices[serialno];vd.newSocket("tcp:53517",function(socket){if(!socket){withSocket();return}writeLine(socket,password,function(){withSocket(socket)})})}else if(adbServer.isRunning()){console.log("adb server socket path");var adb=adbServer.adbDevices[serialno];adb.newSocket("tcp:53517",function(socket){if(!socket){withSocket();return}writeLine(socket,password,function(){withSocket(socket)})})}else{if(true||vysorForceSocket){console.log("adb client socket path");Adb.sendClientCommand({serialno:serialno,command:"tcp:53517"},function(socket){if(!socket){withSocket();return}writeLine(socket,password,function(){withSocket(socket)})})}else{console.log("fetch path");FetchSocket.connect("http://127.0.0.1:"+port+"/h264?password="+password,withSocket)}}}var attemptCount=0;var maxRetries=5;function attemptConnection(){attemptCount++;if(attemptCount==maxRetries){withSocket();return}function reattempt(){console.log("input websocket failed, retrying. attempt "+attemptCount+" out of "+maxRetries);setTimeout(attemptConnection,2e3)}inputWebSocket=new WebSocket("ws://127.0.0.1:"+port+"/input","mirror-protocol");inputWebSocket.onopen=function(){console.log("input websocket opened");inputWebSocket.onerror=null;sendEvent({type:"password",password:password});sendEvent({type:"wakeup"})};inputWebSocket.onerror=reattempt;inputWebSocket.onmessage=function(event){console.log(event.data);var json=JSON.parse(event.data);if(json.type=="displaySize"){var needs264=!rectWidth;var ow=screenWidth;var oh=screenHeight;screenWidth=json.screenWidth;screenHeight=json.screenHeight;enforceAspectRatio(ow,oh);if(needs264)connect264()}else if(json.type=="clip"){copyTextToClipboard(json.clip)}}}attemptConnection()};window.docready();chrome.notifications.onButtonClicked.addListener(function(nid,bid){if(nid=="enableWebGL"){chrome.browser.openTab({url:"https://github.com/koush/vysor.io/issues/3"})}});chrome.notifications.onClicked.addListener(function(nid,bid){if(nid=="enableWebGL"){chrome.browser.openTab({url:"https://github.com/koush/vysor.io/issues/3"})}});$(document).ready(function(){$(".head").bind("mouseup mousedown mousemove",function(e){e.stopPropagation();delayFadeHead()});$("#rotate-button").click(function(){sendEvent({type:"rotate"})});$("#screenshot-button").click(function(){chrome.browser.openTab({url:"http://127.0.0.1:"+port+"/screenshot.jpg?password="+password})});$("#power").click(function(){sendEvent({type:"keycode",keycode:26})});$("#volume-down").click(function(){sendEvent({type:"keycode",keycode:25})});$("#volume-up").click(function(){sendEvent({type:"keycode",keycode:24})});$("#bottom-back").click(function(){sendEvent({type:"keycode",keycode:4})});$("#bottom-home").click(function(){sendEvent({type:"keycode",keycode:3})});$("#bottom-tasks").click(function(){sendEvent({type:"keycode",keycode:187})});chrome.storage.local.get("show-softkeys-"+chrome.app.window.current().id,function(vals){var showSoftkeys=vals["show-softkeys-"+chrome.app.window.current().id]!==false;if(showSoftkeys){bottomBarHeight=48;$(".foot").show()}else{bottomBarHeight=0;$(".foot").hide()}resizeWindow()});$("#softkey-button").click(function(){var softKeyKey="show-softkeys-"+serialno;var setObj={};if($(".foot").is(":visible")){$(".foot").hide();bottomBarHeight=0;setObj[softKeyKey]=false}else{$(".foot").show();bottomBarHeight=48;setObj[softKeyKey]=true}chrome.storage.local.set(setObj);resizeWindow()})});
